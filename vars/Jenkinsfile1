pipeline {
    agent { label 'ec2-agent-1' }

    environment {
        IMAGE_NAME = "mrouby/ivolve-app:latest"
    }

    stages {

        stage('Build Image') {
            steps {
                script {
                    sh "docker build -t ${IMAGE_NAME} ."
                }
            }
        }

        stage('Push Image to DockerHub') {
            steps {
                withDockerRegistry(credentialsId: 'dockerhub', url: '') {
                    script {
                        sh "docker push ${IMAGE_NAME}"
                    }
                }
            }
        }

        stage('Delete Local Image') {
            steps {
                script {
                    sh "docker rmi ${IMAGE_NAME} || true"
                }
            }
        }

    }
}
